/*-----------------------------------------------------------------
 * Name:      crc16.c
 * Purpose:   calculate crc16 value
 *-----------------------------------------------------------------
 * Calculate crc16 value. The generation polynomial is 
 *  X16 + X12 + X5 + 1
 *
 * Copyright (c) *reserve
 
||                       _      _               ||
||    /\  /\  __  _  __ | | __ | | ____  ___ _  ||
||   /  \/  \/ _ ` |/ _ ` |/ _ ` |/ _  \/ _ ` | ||
||  / /\  /\  (_|    (_|    (_|    (_)   (_)  | ||
|| /_/  \/  \_.__, |\__, _|\__, _|\____/\___. | ||
|| =====================================|____/  ||
||                                              ||

 -----------------------------------------------------------------*/
 
/********************************************************************************************************
 *                                               INCLUDES
 ********************************************************************************************************/
#include <stdint.h>

#include "crc16.h"

/********************************************************************************************************
 *                                                 MACROS
 ********************************************************************************************************/
#define POLYNOMIAL 0x1021

/********************************************************************************************************
 *                                               LOCAL VARIABLES
 ********************************************************************************************************/

 
/********************************************************************************************************
 *                                               LOCAL FUNCTIONS
 ********************************************************************************************************/

 
/********************************************************************************************************
 *                                               PUBLIC FUNCTIONS
 ********************************************************************************************************/
 
/*********************************************************************
 * @fn      Crc16
 *
 * @brief   calculate crc 16 value. Generation polynomial:
 *					X16 + X12 + X5 + 1
 *
 * @param   const void *vptr -> input data pointer
 *					uint32_t len -> data length
 *
 * @return  uint16_t -> crc value
 */
#define POLY 0x8408
unsigned short crc16(const void *vptr, unsigned short length)
{
			const uint8_t *data_p = vptr;
      unsigned char i;
      unsigned int data;
      unsigned int crc = 0xffff;

      if (length == 0)
            return (~crc);

      do
      {
            for (i=0, data=(unsigned int)0xff & *data_p++;
                 i < 8; 
                 i++, data >>= 1)
            {
                  if ((crc & 0x0001) ^ (data & 0x0001))
                        crc = (crc >> 1) ^ POLY;
                  else  crc >>= 1;
            }
      } while (--length);

      crc = ~crc;
      data = crc;
      crc = (crc << 8) | (data >> 8 & 0xff);

      return (crc);
}



uint16_t Crc16(const void *vptr, uint32_t len)
{
	const uint8_t *data = vptr;
	uint16_t crc = 0;
	uint8_t i;
	
	// calculate crc value
	while (len--) {
    crc ^= *(unsigned char *)data++ << 8;
    for (i=0; i < 8; i++)
        crc = crc & 0x8000 ? (crc << 1) ^ POLYNOMIAL : crc << 1;
	}
	
	return crc & 0xffff;
}



/*********************************************************************
 */


